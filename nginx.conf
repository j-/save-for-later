server {
  listen 8080;
  server_name _;

  root /usr/share/nginx/html;

  # Service worker must be a real file, not the SPA fallback.
  location = /service-worker.js {
    try_files $uri =404;

    # Avoid "stuck" SW updates due to aggressive caching.
    add_header Cache-Control "no-cache" always;

    # Optional: if you ever serve the SW from a subpath but want wider scope.
    # add_header Service-Worker-Allowed "/" always;

    # Ensure correct MIME type even if types aren't loaded
    default_type application/javascript;
  }

  # (Optional but common) Manifest usually also shouldn't be aggressively cached during iteration.
  location = /manifest.webmanifest {
    try_files $uri =404;
    add_header Cache-Control "no-cache" always;
  }

  # Static assets can be cached hard if theyâ€™re content-hashed.
  location /assets/ {
    try_files $uri =404;
    add_header Cache-Control "public, max-age=31536000, immutable" always;
  }

  # Share Target POST endpoint (SW-only).
  # If SW intercepts, this block is never used.
  # If SW *doesn't* intercept (first run / update), prevent Nginx 405/ERR_FAILED.
  location = /share {
    error_page 405 =200 /index.html;
    try_files /index.html =404;
    add_header Cache-Control "no-store" always;
  }

  # SPA fallback for client-side routing:
  # - serve real files if they exist
  # - otherwise serve /index.html for any path
  location / {
    try_files $uri /index.html;
    add_header Cache-Control "no-cache" always;
  }
}
